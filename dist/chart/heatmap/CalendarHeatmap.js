"use strict";function _typeof(obj){"@babel/helpers - typeof";return _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(obj){return typeof obj}:function(obj){return obj&&"function"==typeof Symbol&&obj.constructor===Symbol&&obj!==Symbol.prototype?"symbol":typeof obj},_typeof(obj)}Object.defineProperty(exports,"__esModule",{value:!0}),exports["default"]=CalendarHeatmap;var _react=_interopRequireDefault(require("react")),d3=_interopRequireWildcard(require("d3")),_svg=require("./../../components/svg.ts"),_chart=require("./../../components/chart.ts"),_tooltip=require("./../../components/tooltip.ts"),_dom=require("./../../utils/dom.ts"),_text=require("./../../components/text.ts"),_propTypes=_interopRequireDefault(require("prop-types")),_legend=require("./../../components/legend.ts");function _getRequireWildcardCache(nodeInterop){if("function"!=typeof WeakMap)return null;var cacheBabelInterop=new WeakMap,cacheNodeInterop=new WeakMap;return(_getRequireWildcardCache=function(nodeInterop){return nodeInterop?cacheNodeInterop:cacheBabelInterop})(nodeInterop)}function _interopRequireWildcard(obj,nodeInterop){if(!nodeInterop&&obj&&obj.__esModule)return obj;if(null===obj||"object"!==_typeof(obj)&&"function"!=typeof obj)return{default:obj};var cache=_getRequireWildcardCache(nodeInterop);if(cache&&cache.has(obj))return cache.get(obj);var newObj={},hasPropertyDescriptor=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var key in obj)if("default"!=key&&Object.prototype.hasOwnProperty.call(obj,key)){var desc=hasPropertyDescriptor?Object.getOwnPropertyDescriptor(obj,key):null;desc&&(desc.get||desc.set)?Object.defineProperty(newObj,key,desc):newObj[key]=obj[key]}return newObj["default"]=obj,cache&&cache.set(obj,newObj),newObj}function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}function _slicedToArray(arr,i){return _arrayWithHoles(arr)||_iterableToArrayLimit(arr,i)||_unsupportedIterableToArray(arr,i)||_nonIterableRest()}function _nonIterableRest(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function _unsupportedIterableToArray(o,minLen){if(o){if("string"==typeof o)return _arrayLikeToArray(o,minLen);var n=Object.prototype.toString.call(o).slice(8,-1);return"Object"===n&&o.constructor&&(n=o.constructor.name),"Map"===n||"Set"===n?Array.from(o):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?_arrayLikeToArray(o,minLen):void 0}}function _arrayLikeToArray(arr,len){(null==len||len>arr.length)&&(len=arr.length);for(var i=0,arr2=Array(len);i<len;i++)arr2[i]=arr[i];return arr2}function _iterableToArrayLimit(arr,i){var _i=null==arr?null:"undefined"!=typeof Symbol&&arr[Symbol.iterator]||arr["@@iterator"];if(null!=_i){var _s,_e,_x,_r,_arr=[],_n=!0,_d=!1;try{if(_x=(_i=_i.call(arr)).next,0===i){if(Object(_i)!==_i)return;_n=!1}else for(;!(_n=(_s=_x.call(_i)).done)&&(_arr.push(_s.value),_arr.length!==i);_n=!0);}catch(err){_d=!0,_e=err}finally{try{if(!_n&&null!=_i["return"]&&(_r=_i["return"](),Object(_r)!==_r))return}finally{if(_d)throw _e}}return _arr}}function _arrayWithHoles(arr){if(Array.isArray(arr))return arr}function CalendarHeatmap(props){var svgRef=_react["default"].useRef(null),handleLoad=function(){(0,_chart.RemoveChart)(svgRef),CreateCalendarHeatmap(svgRef,props)};return _react["default"].useEffect(function(){handleLoad()},[props]),_react["default"].createElement("svg",{width:"100%",ref:svgRef})}function CreateCalendarHeatmap(element,props){function pathMonth(t){var d=Math.max(0,Math.min(weekDays,countDay(t.getUTCDay()))),w=timeWeek.count(d3.utcYear(t),t);return"".concat(0===d?"M".concat(w*cellSize,",0"):d===weekDays?"M".concat((w+1)*cellSize,",0"):"M".concat((w+1)*cellSize,",0V").concat(d*cellSize,"H").concat(w*cellSize),"V").concat(weekDays*cellSize)}var data=props.data,mapper=props.mapper,base=props.base,margin=props.margin,animation=props.animation,legend=props.legend,heatmap=props.heatmap,tooltip=props.tooltip,font=props.font;if(0!==data.length){void 0===base.width&&(base.width=(0,_dom.getElementWidth)(element)),void 0===base.height&&(base.height=(0,_dom.getElementHeight)(element));var x=d3.map(d3.map(data,mapper.getX),function(d){return d3.utcParse(heatmap.utcParse)(d)}),y=d3.map(d3.map(data,mapper.getY),function(d){return+d}),I=d3.range(x.length),cellSize=(base.width-margin.top-margin.right)/53;void 0===tooltip.mapper&&(tooltip.mapper=function(i){return"date: ".concat(d3.utcFormat(heatmap.formatUTCTip)(x[i]),"\nvalue: ").concat(y[i])}),void 0===font.size&&(font.size=Math.min(base.width,base.height)/25+"px");var colorScale,countDay="sunday"===heatmap.weekday?function(i){return i}:function(i){return(i+6)%7},timeWeek="sunday"===heatmap.weekday?d3.utcSunday:d3.utcMonday,weekDays="weekday"===heatmap.weekday?5:7,height=cellSize*(weekDays+2),years=d3.groups(I,function(i){return x[i].getFullYear()}).reverse(),max=d3.quantile(y,.9975,Math.abs),formatMonth=d3.utcFormat(heatmap.monthParse);if(void 0===base.color)colorScale=d3.scaleSequential([-max,max],d3.interpolateBuGn).unknown("none");else{var interpolator=d3.interpolate(base.color[0],base.color[1]);colorScale=d3.scaleSequential([-max,max],interpolator).unknown("none")}var svg=(0,_svg.createSVG)(element,base.width,height*years.length+margin.top+margin.bottom),year=svg.selectAll("g").data(years).join("g").attr("transform",function(_,i){return"translate(".concat(margin.left,", ").concat(margin.top+height*i+1.5*cellSize,")")});year.append("text").attr("x",-5).attr("y",-5).attr("font-size",font.size).attr("font-weight","bold").attr("text-anchor","end").text(function(_ref){var _ref2=_slicedToArray(_ref,1),key=_ref2[0];return key}),year.append("g").attr("text-anchor","end").attr("font-size",font.size).selectAll("text").data("weekday"===heatmap.weekday?d3.range(1,6):d3.range(7)).join("text").attr("x",-5).attr("y",function(i){return(countDay(i)+.5)*cellSize}).attr("dy","0.31em").text(heatmap.formatDay);var cell=year.append("g");cell.selectAll("rect").data("weekday"===heatmap.weekday?function(_ref3){var _ref4=_slicedToArray(_ref3,2),I=_ref4[1];return I.filter(function(i){return![0,6].includes(x[i].getUTCDay())})}:function(_ref5){var _ref6=_slicedToArray(_ref5,2),I=_ref6[1];return I}).join("rect").attr("class",function(i){return"cell_"+x[i].getFullYear()}).attr("width",cellSize-1).attr("height",cellSize-1).attr("x",function(i){return timeWeek.count(d3.utcYear(x[i]),x[i])*cellSize+.5}).attr("y",function(i){return countDay(x[i].getUTCDay())*cellSize+.5}).attr("rx",3).attr("fill",function(i){return colorScale(y[i])});var month=year.append("g").selectAll("g").data(function(_ref7){var _ref8=_slicedToArray(_ref7,2),I=_ref8[1];return d3.utcMonths(d3.utcMonth(x[I[0]]),x[I[I.length-1]])}).join("g");if(month.filter(function(d,i){return i}).append("path").attr("fill","none").attr("stroke","white").attr("stroke-width",3).attr("d",pathMonth),month.append("text").attr("x",function(d){return timeWeek.count(d3.utcYear(d),timeWeek.ceil(d))*cellSize+2}).attr("y",-5).attr("font-size",font.size).text(formatMonth),(0,_text.createTitle)(svg,props),animation.enabled)for(var i=0;11>i;i++)cell.selectAll("rect").data("weekday"===heatmap.weekday?function(_ref9){var _ref10=_slicedToArray(_ref9,2),I=_ref10[1];return I.filter(function(i){return![0,6].includes(x[i].getUTCDay())})}:function(_ref11){var _ref12=_slicedToArray(_ref11,2),I=_ref12[1];return I}).attr("fill","none").attr("width",0).transition().attr("width",cellSize-1).attr("fill",function(i){return colorScale(y[i])}).duration(animation.duration).ease(d3.easeExpInOut);(0,_legend.createSequentialLegend)(svg,colorScale,props),tooltip.enabled&&years.forEach(function(y,i){var _createTooltip=(0,_tooltip.createTooltip)(svg,props,margin.left,margin.top+1.5*cellSize+height*i),showTooltip=_createTooltip.showTooltip,moveTooltip=_createTooltip.moveTooltip,hideTooltip=_createTooltip.hideTooltip;cell.selectAll(".cell_"+y[0]).on("mouseover",showTooltip).on("mousemove",moveTooltip).on("mouseleave",hideTooltip)})}}CalendarHeatmap.propTypes={data:_propTypes["default"].arrayOf(_propTypes["default"].object).isRequired,mapper:_propTypes["default"].objectOf(_propTypes["default"].any),base:_propTypes["default"].objectOf(_propTypes["default"].any),margin:_propTypes["default"].objectOf(_propTypes["default"].number),tooltip:_propTypes["default"].objectOf(_propTypes["default"].any),animation:_propTypes["default"].objectOf(_propTypes["default"].any),legend:_propTypes["default"].objectOf(_propTypes["default"].any),font:_propTypes["default"].objectOf(_propTypes["default"].any),heatmap:_propTypes["default"].objectOf(_propTypes["default"].any)},CalendarHeatmap.defaultProps={mapper:{getX:function getX(d){return d.date},getY:function getY(d){return d.value}},base:{title:"CalendarHeatmap",width:void 0,colors:void 0},tooltip:{mapper:void 0,enabled:!0},margin:{top:65,bottom:0,left:40,right:0},legend:{title:"frequency",enabled:!0},font:{size:"12px"},animation:{enabled:!0,duration:2e3},heatmap:{utcParse:"%Y-%m-%d",monthParse:"%b",formatUTCTip:"%Y-%m-%d",formatDay:function formatDay(i){return"SMTWTFS"[i]},formatTick:void 0,weekday:"sunday"}};
"use strict";function _typeof(obj){"@babel/helpers - typeof";return _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(obj){return typeof obj}:function(obj){return obj&&"function"==typeof Symbol&&obj.constructor===Symbol&&obj!==Symbol.prototype?"symbol":typeof obj},_typeof(obj)}Object.defineProperty(exports,"__esModule",{value:!0}),exports["default"]=Doughnut;var _chart=require("../../components/chart"),_react=_interopRequireDefault(require("react")),_propTypes=_interopRequireDefault(require("prop-types")),d3=_interopRequireWildcard(require("d3")),_svg=require("../../components/svg"),_dom=require("../../utils/dom"),_text=require("../../components/text"),_tooltip=require("../../components/tooltip"),_legend=require("../../components/legend");function _getRequireWildcardCache(nodeInterop){if("function"!=typeof WeakMap)return null;var cacheBabelInterop=new WeakMap,cacheNodeInterop=new WeakMap;return(_getRequireWildcardCache=function(nodeInterop){return nodeInterop?cacheNodeInterop:cacheBabelInterop})(nodeInterop)}function _interopRequireWildcard(obj,nodeInterop){if(!nodeInterop&&obj&&obj.__esModule)return obj;if(null===obj||"object"!==_typeof(obj)&&"function"!=typeof obj)return{default:obj};var cache=_getRequireWildcardCache(nodeInterop);if(cache&&cache.has(obj))return cache.get(obj);var newObj={},hasPropertyDescriptor=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var key in obj)if("default"!=key&&Object.prototype.hasOwnProperty.call(obj,key)){var desc=hasPropertyDescriptor?Object.getOwnPropertyDescriptor(obj,key):null;desc&&(desc.get||desc.set)?Object.defineProperty(newObj,key,desc):newObj[key]=obj[key]}return newObj["default"]=obj,cache&&cache.set(obj,newObj),newObj}function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}function Doughnut(props){var svgRef=_react["default"].useRef(null),handleLoad=function(){(0,_chart.RemoveChart)(svgRef),createDoughnut(svgRef,props)};return _react["default"].useEffect(function(){handleLoad()},[props]),_react["default"].createElement("svg",{width:"100%",ref:svgRef})}function createDoughnut(element,props){var data=props.data,mapper=props.mapper,base=props.base,margin=props.margin,tooltip=props.tooltip,animation=props.animation,legend=props.legend,font=props.font,pie=props.pie,stroke=props.stroke,fill=props.fill;if(0!==data.length){void 0===base.width&&(base.width=(0,_dom.getElementWidth)(element)),void 0===base.height&&(base.height=(0,_dom.getElementHeight)(element)),void 0===pie.radius.outer&&(pie.radius.outer=Math.max(base.width-margin.left-margin.right,base.height-margin.top-margin.bottom)/4),void 0===pie.radius.inner&&(pie.radius.inner=pie.radius.outer/2),void 0===pie.radius.label&&(pie.radius.label=1.2*pie.radius.outer),void 0===pie.radius.corner&&(pie.radius.corner=8),void 0===pie.padAngle&&(pie.padAngle=.01);var label=d3.map(data,mapper.getX),distinctLabel=new d3.InternSet(label.filter(function(d){return""!=d})),value=d3.map(data,mapper.getY),valueSum=d3.sum(value),I=d3.range(label.length).filter(function(i){return!isNaN(value[i])&&distinctLabel.has(label[i])});void 0===font.size&&(font.size=Math.min(base.width,base.height)/25+"px"),void 0===tooltip.mapper&&(tooltip.mapper=function(i){return"label : ".concat(label[i],"\nvalue : ").concat(value[i])}),void 0===fill.color&&(fill.color=d3.schemeAccent);var colorScale=d3.scaleOrdinal(fill.color),divData=d3.pie().padAngle(pie.padAngle).sort(null).value(function(i){return value[i]})(I),arcs=d3.arc().innerRadius(pie.radius.inner).outerRadius(pie.radius.outer).cornerRadius(pie.radius.corner),arcsOuterTimes=d3.arc().innerRadius(0).outerRadius(2*pie.radius.outer),arcLabel=d3.arc().innerRadius(pie.radius.label).outerRadius(pie.radius.label),arcValue=d3.arc().innerRadius(.7*pie.radius.outer).outerRadius(.7*pie.radius.outer),arcLabelTimes=d3.arc().innerRadius(1.2*pie.radius.label).outerRadius(1.2*pie.radius.label),pieCentroid=[margin.left+(base.width-margin.left-margin.right)/2,margin.top+(base.height-margin.top-margin.bottom)/2],svg=(0,_svg.createSVG)(element,base.width,base.height);(0,_text.createTitle)(svg,props);var pieLabel=svg.append("g").attr("text-anchor","middle").attr("transform","translate(".concat(pieCentroid,")")),Pie=svg.append("g").attr("transform","translate(".concat(pieCentroid,")")),pieValue=svg.append("g").attr("text-anchor","middle").attr("transform","translate(".concat(pieCentroid,")"));Pie.selectAll("path").data(divData).join("path").attr("class",function(_,i){return"svg-pie pie_"+i}).attr("fill",function(d){return colorScale(label[d.data])}).attr("d",function(d){return arcs(d)}),pieLabel.selectAll("polyline").data(divData).join("polyline").transition().attr("stroke","currentColor").attr("fill","none").attr("stroke-width",stroke.width).attr("points",function(d){if(d.endAngle-d.startAngle<4*+font.size.slice(0,-2)/100)return"";var p1=arcsOuterTimes.centroid(d),p2=arcLabel.centroid(d),p3=arcLabel.centroid(d);return p3[0]=arcLabelTimes.centroid(d)[0],[p1,p2,p3].join(",")}),pieLabel.selectAll("text").data(divData).join("text").style("font-size",font.size).style("fill","currentColor").attr("text-anchor",function(d){var midAngle=d.startAngle+(d.endAngle-d.startAngle)/2;return midAngle<Math.PI?"start":"end"}).attr("transform",function(d){var p=arcLabel.centroid(d),midAngle=d.startAngle+(d.endAngle-d.startAngle)/2;return p[0]=arcLabelTimes.centroid(d)[0]+5*(midAngle<Math.PI?1:-1),"translate(".concat(p,")")}),pieLabel.selectAll("text").data(divData).selectAll("tspan").data(function(d){var lines="".concat(label[d.data]).split(/\n/);return d.endAngle-d.startAngle>4*+font.size.slice(0,-2)/100?lines:lines.slice(0,0)}).join("tspan").attr("x",0).attr("y",function(_,i){return"".concat(1.1*i,"em")}).attr("font-weight",function(_,i){return i?null:"bold"}).text(function(d){return d}),pie.value.enabled&&(pieValue.selectAll("text").data(divData).join("text").attr("class",function(d){return"pieValue pieValue_"+d.data}).attr("font-size",font.size).attr("fill",pie.value.color).attr("text-anchor","middle").attr("transform",function(d){var p=arcValue.centroid(d);return"translate(".concat(p,")")}),pieValue.selectAll("text").data(divData).selectAll("tspan").data(function(d){var lines="".concat(value[d.data]).split(/\n/);return d.endAngle-d.startAngle>4*+font.size.slice(0,-2)/100?lines:""}).join("tspan").attr("x",0).attr("y",function(_,i){return"".concat(1.1*i,"em")}).attr("font-weight",function(_,i){return i?null:"bold"}).text(function(d){return d}));var onHover=function(_,i){var arcScale=.1,hoverArc=d3.arc().innerRadius(pie.radius.inner*arcScale).outerRadius(pie.radius.outer*arcScale),hoverValue=d3.arc().innerRadius(.7*pie.radius.outer*(1+arcScale)).outerRadius(.7*pie.radius.outer*(1+arcScale));Pie.select(".pie_"+i).transition().attr("transform","translate(".concat(hoverArc.centroid(divData[i]),")")).duration(500).ease(d3.easeElasticOut.amplitude(1).period(.3)),pieValue.select(".pieValue_"+i).transition().attr("transform","translate(".concat(hoverValue.centroid(divData[i]),")")).duration(500).ease(d3.easeElasticOut.amplitude(1).period(.3))},noHover=function(){Pie.selectAll(".svg-pie").transition().attr("transform","translate(0, 0)").duration(500).ease(d3.easeElasticOut.amplitude(1).period(.3)),pieValue.selectAll(".pieValue").data(divData).transition().attr("transform",function(d){var p=arcValue.centroid(d);return"translate(".concat(p,")")}).duration(500).ease(d3.easeElasticOut.amplitude(1).period(.3))};if(animation.enabled&&(Pie.selectAll("path").data(I).attr("fill","none").transition().attrTween("d",function(i){var interpolate=d3.interpolate({startAngle:0,endAngle:0},divData[i]);return function(t){return arcs(interpolate(t))}}).attr("fill",function(i){return colorScale(label[i])}).duration(animation.duration).ease(d3.easeExpInOut),pie.value.enabled&&pieValue.selectAll("text").data(divData).selectAll("tspan").data(function(d){var lines="".concat(value[d.data]/valueSum).split(/\n/);return d.endAngle-d.startAngle>4*+font.size.slice(0,-2)/100?lines:""}).transition().textTween(function(d){var formatValue=d3.format(".1%"),f=d3.interpolate(0,+d);return function(t){return formatValue(f(t))}}).duration(animation.duration).ease(d3.easeExpInOut)),legend.enabled&&(0,_legend.createLegend)(svg,Array.from(distinctLabel),colorScale,props,onHover,noHover),tooltip.enabled){var _createTooltip=(0,_tooltip.createTooltip)(svg,props,pieCentroid[0],pieCentroid[1]),showTooltip=_createTooltip.showTooltip,moveTooltip=_createTooltip.moveTooltip,hideTooltip=_createTooltip.hideTooltip;Pie.selectAll("path").data(I).on("mouseover",showTooltip).on("mousemove",moveTooltip).on("mouseleave",hideTooltip)}}}Doughnut.propTypes={data:_propTypes["default"].arrayOf(_propTypes["default"].object).isRequired,mapper:_propTypes["default"].objectOf(_propTypes["default"].any),base:_propTypes["default"].objectOf(_propTypes["default"].any),margin:_propTypes["default"].objectOf(_propTypes["default"].number),tooltip:_propTypes["default"].objectOf(_propTypes["default"].any),animation:_propTypes["default"].objectOf(_propTypes["default"].any),legend:_propTypes["default"].objectOf(_propTypes["default"].any),stroke:_propTypes["default"].objectOf(_propTypes["default"].any),fill:_propTypes["default"].objectOf(_propTypes["default"].any),font:_propTypes["default"].objectOf(_propTypes["default"].any),pie:_propTypes["default"].objectOf(_propTypes["default"].any)},Doughnut.defaultProps={map:{getX:function getX(d){return d.x},getY:function getY(d){return d.y}},base:{width:void 0,height:300,title:"",color:void 0},tooltip:{map:void 0,enabled:!0},stroke:{width:1},fill:{},margin:{top:40,right:150,bottom:60,left:60},animation:{duration:1e3,enabled:!0},legend:{enabled:!0},font:{size:"12px"},pie:{radius:{outer:void 0,inner:void 0,label:void 0,corner:void 0},value:{color:"rgb(114, 95, 78)",enabled:!0},padAngle:void 0,enableLabel:!0}};
"use strict";function _typeof(obj){"@babel/helpers - typeof";return _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(obj){return typeof obj}:function(obj){return obj&&"function"==typeof Symbol&&obj.constructor===Symbol&&obj!==Symbol.prototype?"symbol":typeof obj},_typeof(obj)}Object.defineProperty(exports,"__esModule",{value:!0}),exports["default"]=CalendarHeatmap;var _react=_interopRequireDefault(require("react")),d3=_interopRequireWildcard(require("d3")),_propTypes=_interopRequireDefault(require("prop-types"));function _getRequireWildcardCache(nodeInterop){if("function"!=typeof WeakMap)return null;var cacheBabelInterop=new WeakMap,cacheNodeInterop=new WeakMap;return(_getRequireWildcardCache=function(nodeInterop){return nodeInterop?cacheNodeInterop:cacheBabelInterop})(nodeInterop)}function _interopRequireWildcard(obj,nodeInterop){if(!nodeInterop&&obj&&obj.__esModule)return obj;if(null===obj||"object"!==_typeof(obj)&&"function"!=typeof obj)return{default:obj};var cache=_getRequireWildcardCache(nodeInterop);if(cache&&cache.has(obj))return cache.get(obj);var newObj={},hasPropertyDescriptor=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var key in obj)if("default"!=key&&Object.prototype.hasOwnProperty.call(obj,key)){var desc=hasPropertyDescriptor?Object.getOwnPropertyDescriptor(obj,key):null;desc&&(desc.get||desc.set)?Object.defineProperty(newObj,key,desc):newObj[key]=obj[key]}return newObj["default"]=obj,cache&&cache.set(obj,newObj),newObj}function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}function _slicedToArray(arr,i){return _arrayWithHoles(arr)||_iterableToArrayLimit(arr,i)||_unsupportedIterableToArray(arr,i)||_nonIterableRest()}function _nonIterableRest(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function _unsupportedIterableToArray(o,minLen){if(o){if("string"==typeof o)return _arrayLikeToArray(o,minLen);var n=Object.prototype.toString.call(o).slice(8,-1);return"Object"===n&&o.constructor&&(n=o.constructor.name),"Map"===n||"Set"===n?Array.from(o):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?_arrayLikeToArray(o,minLen):void 0}}function _arrayLikeToArray(arr,len){(null==len||len>arr.length)&&(len=arr.length);for(var i=0,arr2=Array(len);i<len;i++)arr2[i]=arr[i];return arr2}function _iterableToArrayLimit(arr,i){var _i=null==arr?null:"undefined"!=typeof Symbol&&arr[Symbol.iterator]||arr["@@iterator"];if(null!=_i){var _s,_e,_x,_r,_arr=[],_n=!0,_d=!1;try{if(_x=(_i=_i.call(arr)).next,0===i){if(Object(_i)!==_i)return;_n=!1}else for(;!(_n=(_s=_x.call(_i)).done)&&(_arr.push(_s.value),_arr.length!==i);_n=!0);}catch(err){_d=!0,_e=err}finally{try{if(!_n&&null!=_i["return"]&&(_r=_i["return"](),Object(_r)!==_r))return}finally{if(_d)throw _e}}return _arr}}function _arrayWithHoles(arr){if(Array.isArray(arr))return arr}function CalendarHeatmap(props){var svgRef=_react["default"].useRef(null),handleLoad=function(){RemoveCalendarHeatmap(svgRef.current),CreateCalendarHeatmap(svgRef.current,props)};return _react["default"].useEffect(function(){handleLoad()},[]),_react["default"].createElement("svg",{ref:svgRef})}CalendarHeatmap.propTypes={data:_propTypes["default"].array.isRequired,mapFunction:_propTypes["default"].objectOf(_propTypes["default"].func),title:_propTypes["default"].string,width:_propTypes["default"].number,colors:_propTypes["default"].any,margin:_propTypes["default"].objectOf(_propTypes["default"].number),legend:_propTypes["default"].object,animation:_propTypes["default"].object,cellSize:_propTypes["default"].number,utcParse:_propTypes["default"].string,monthParse:_propTypes["default"].string,formatUTCTip:_propTypes["default"].string,formatDay:_propTypes["default"].func,formatTick:_propTypes["default"].any,weekday:_propTypes["default"].string},CalendarHeatmap.defaultProps={mapFunction:{getX:function getX(d){return d.date},getY:function getY(d){return d.value},getTooltipTitle:void 0},title:"CalendarHeatmap",width:900,margin:{top:65,bottom:0,left:40,right:0},colors:void 0,legend:{title:"frequency",enabled:!0},animation:{enabled:!0,duration:2e3},cellSize:0,utcParse:"%Y-%m-%d",monthParse:"%b",formatUTCTip:"%Y-%m-%d",formatDay:function formatDay(i){return"SMTWTFS"[i]},formatTick:void 0,weekday:"sunday"};function RemoveCalendarHeatmap(element){d3.select(element).selectAll("g").remove()}function CreateCalendarHeatmap(element,props){function pathMonth(t){var d=Math.max(0,Math.min(weekDays,countDay(t.getUTCDay()))),w=timeWeek.count(d3.utcYear(t),t);return"".concat(0===d?"M".concat(w*cellSize,",0"):d===weekDays?"M".concat((w+1)*cellSize,",0"):"M".concat((w+1)*cellSize,",0V").concat(d*cellSize,"H").concat(w*cellSize),"V").concat(weekDays*cellSize)}function showTooltip(_,i){tooltip.style("display",null);var yearIndex=years.findIndex(function(_ref9){var _ref10=_slicedToArray(_ref9,1),key=_ref10[0];return key===x[i].getFullYear()});tooltip.attr("transform","translate(\n        ".concat(margin.left+timeWeek.count(d3.utcYear(x[i]),x[i])*cellSize+.5+(cellSize-1)/2,",\n        ").concat(margin.top+countDay(x[i].getUTCDay())*cellSize+.5-10+(height*yearIndex+1.5*cellSize),"\n      )"));var path=tooltip.selectAll("path").data([,]).join("path").attr("fill","rgba(250, 250, 250, 0.8)").attr("stroke","rgba(200, 200, 200, 1)").attr("stroke","black").attr("color","black"),text=tooltip.selectAll("text").data([,]).join("text").attr("id","tooltip-text").style("font-size",fontSize).call(function(text){return text.selectAll("tspan").data("".concat(mapFunction.getTooltipTitle(i)).split(/\n/)).join("tspan").attr("x",0).attr("y",function(_,i){return"".concat(1.1*i,"em")}).attr("font-weight",function(_,i){return i?null:"bold"}).text(function(d){return d})}),textBox=text.node().getBBox();text.attr("transform","translate(".concat(-textBox.width/2,", ").concat(-textBox.height+5,")")),path.attr("d","M".concat(-textBox.width/2-10,",5H-5l5,5l5,-5H").concat(textBox.width/2+10,"v").concat(-textBox.height-20,"h-").concat(textBox.width+20,"z"))}function hideTooltip(_,i){tooltip.style("display","none")}function ramp(color){var n=1<arguments.length&&void 0!==arguments[1]?arguments[1]:256,canvas=document.createElement("canvas");canvas.width=n,canvas.height=1;var context=canvas.getContext("2d",{willReadFrequently:!0});if(null!==context){for(var _i2=0;_i2<n;_i2++)context.fillStyle=color(_i2/(n-1)),context.fillRect(_i2,0,1,1);return canvas}}var data=props.data,mapFunction=props.mapFunction,utcParse=props.utcParse,cellSize=props.cellSize,formatUTCTip=props.formatUTCTip,weekday=props.weekday,monthParse=props.monthParse,formatDay=props.formatDay,formatTick=props.formatTick,title=props.title,width=props.width,margin=props.margin,colors=props.colors,animation=props.animation,legend=props.legend,x=d3.map(d3.map(data,mapFunction.getX),function(d){return d3.utcParse(utcParse)(d)}),y=d3.map(d3.map(data,mapFunction.getY),function(d){return+d}),I=d3.range(x.length);cellSize=(width-margin.top-margin.right)/53,void 0===mapFunction.getTooltipTitle&&(mapFunction.getTooltipTitle=function(i){return"date: ".concat(d3.utcFormat(formatUTCTip)(x[i]),"\nvalue: ").concat(y[i])});var countDay="sunday"===weekday?function(i){return i}:function(i){return(i+6)%7},timeWeek="sunday"===weekday?d3.utcSunday:d3.utcMonday,weekDays="weekday"===weekday?5:7,height=cellSize*(weekDays+2),fontSize=(width+height)/100,years=d3.groups(I,function(i){return x[i].getFullYear()}).reverse();void 0===colors&&(colors=d3.interpolateBrBG);var max=d3.quantile(y,.9975,Math.abs),colorScale=d3.scaleSequential([-max,max],colors).unknown("none"),formatMonth=d3.utcFormat(monthParse),svg=d3.select(element).attr("width",width).attr("height",height*years.length+margin.top+margin.bottom).attr("viewbox",[0,0,width,height*years.length+margin.top+margin.bottom]).attr("overflow","visible"),year=svg.selectAll("g").data(years).join("g").attr("transform",function(d,i){return"translate(".concat(margin.left,", ").concat(margin.top+height*i+1.5*cellSize,")")});year.append("text").attr("x",-5).attr("y",-5).attr("font-size",fontSize).attr("font-weight","bold").attr("text-anchor","end").text(function(_ref){var _ref2=_slicedToArray(_ref,1),key=_ref2[0];return key}),year.append("g").attr("text-anchor","end").attr("font-size",fontSize).selectAll("text").data("weekday"===weekday?d3.range(1,6):d3.range(7)).join("text").attr("x",-5).attr("y",function(i){return(countDay(i)+.5)*cellSize}).attr("dy","0.31em").text(formatDay);var cell=year.append("g");cell.selectAll("rect").data("weekday"===weekday?function(_ref3){var _ref4=_slicedToArray(_ref3,2),I=_ref4[1];return I.filter(function(i){return![0,6].includes(x[i].getUTCDay())})}:function(_ref5){var _ref6=_slicedToArray(_ref5,2),I=_ref6[1];return I}).join("rect").attr("class",function(i){return"cell_"+x[i].getUTCMonth()}).attr("width",cellSize-1).attr("height",cellSize-1).attr("x",function(i){return timeWeek.count(d3.utcYear(x[i]),x[i])*cellSize+.5}).attr("y",function(i){return countDay(x[i].getUTCDay())*cellSize+.5}).attr("fill",function(i){return colorScale(y[i])});var month=year.append("g").selectAll("g").data(function(_ref7){var _ref8=_slicedToArray(_ref7,2),I=_ref8[1];return d3.utcMonths(d3.utcMonth(x[I[0]]),x[I[I.length-1]])}).join("g");month.filter(function(d,i){return i}).append("path").attr("fill","none").attr("stroke","white").attr("stroke-width",3).attr("d",pathMonth),month.append("text").attr("x",function(d){return timeWeek.count(d3.utcYear(d),timeWeek.ceil(d))*cellSize+2}).attr("y",-5).attr("font-size",fontSize).text(formatMonth);var chartTitle=svg.append("g").call(function(g){return g.append("text").attr("x",margin.left+(width-margin.right-margin.left)/2).attr("y",margin.top/2).attr("fill","black").style("font-size","20px").style("font-weight",550).attr("text-anchor","middle").text(title)}),tooltip=svg.append("g").attr("pointer-events","none");if(function setToolTop(){cell.selectAll("rect").on("mouseover.tooltip",showTooltip).on("mouseleave.tooltip",hideTooltip)}(),animation.enabled)for(var i=0;11>i;i++)cell.selectAll("rect").data("weekday"===weekday?function(_ref11){var _ref12=_slicedToArray(_ref11,2),I=_ref12[1];return I.filter(function(i){return![0,6].includes(x[i].getUTCDay())})}:function(_ref13){var _ref14=_slicedToArray(_ref13,2),I=_ref14[1];return I}).attr("fill","none").attr("width",0).transition().attr("width",cellSize-1).attr("fill",function(i){return colorScale(y[i])}).duration(animation.duration);if(legend.enabled){var chart_legendX=Object.assign(colorScale.copy().interpolator(d3.interpolateRound(0,200)),{range:function range(){return[0,200]}}),chart_legend=svg.append("g").attr("transform","translate(10, ".concat(margin.top/3,")"));chart_legend.append("image").attr("x",0).attr("y",0).attr("width",200).attr("height",10).attr("preserveAspectRatio","none").attr("xlink:href",function(){var canvasElement=ramp(colorScale.interpolator());return void 0===canvasElement?null:canvasElement.toDataURL()});var ticks=width/250,n=Math.round(ticks+1),tickValues=d3.range(n).map(function(i){return d3.quantile(colorScale.domain(),i/(n-1))}),tickFormat=d3.format(void 0===formatTick?",.0f":formatTick);chart_legend.append("g").attr("transform","translate(0, 10)").call(d3.axisBottom(chart_legendX).ticks(ticks,formatTick).tickFormat(tickFormat).tickSize(6).tickValues(tickValues)).call(function(g){return g.selectAll(".tick line").attr("y1",-10)}).call(function(g){return g.select(".domain").remove()}).call(function(g){return g.append("text").attr("x",0).attr("y",-16).attr("fill","black").attr("text-anchor","start").attr("font-weight","bold").text(legend.title)})}}